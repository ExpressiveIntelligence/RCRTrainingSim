RunStory ?frag:
    [StoryAssembler ?]
    # [Paragraph]
    # [StoryAssembler ?]
    # [Paragraph]
    # [StoryAssembler ?]
    # [Paragraph]
    # [StoryAssembler ?]
    # [Paragraph]
    # [StoryAssembler ?]
    # [Paragraph]
[end]

initially:
    [set ^CurrentScene = test]
    [set ^CatTemp = empty]
[end]

RunStoryWrap: [RunStory ?frag]

# Custom list operations
Cat ?l1 ?l2 ?result:
    [set ^CatTemp = empty]
    [add 1 CatTemp]
    # [DoAll [Member ?x ?l1] [add 1 CatTemp]]
    # [DoAll [Member ?x ?l2] [add 1 ^CatTemp]]
    [= ?result ^CatTemp]
[end]

# A helper function to add an element to a list
Add ?element ?list ?new_list:
    [set ^AddTemp = empty]
    [AddHelperAdd ?element]
    [= ?new_list ^AddTemp]
[end]

SetUnion ?l1 ?l2 ?union:
    [set ^AddTemp = empty]
    [ForEach [Member ?x ?l1] [AddHelperAdd ?x]]
    [ForEach [Member ?y ?l2] [Not [Member ?y ?l1]] [AddHelperAdd ?y]]
    [= ?union ^AddTemp]
[end]

SetIntersection ?l1 ?l2 ?int:
    [set ^AddTemp = empty]
    [ForEach [Member ?x ?l1] [Member ?x ?l2] [AddHelperAdd ?x]]
    [= ?int ^AddTemp]
[end]

AddHelperAdd ?element:
    [add ?element ^AddTemp]
[end]

# Custom max check
[predicate]
MaxOf ?x ?y ?max: [< ?x ?y] [set ?max = ?y]
MaxOf ?x ?y ?max: [set ?max = ?x]

SetupTestScene:
    [set CurrentScene = test]
    [InitScene ^CurrentScene]
[end]

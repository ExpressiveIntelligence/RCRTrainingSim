initially:
    [set ^CurrentFragment = root]
    [set ^NextBestChoices = empty]
[end]

MakeChoice ?choice_id:
    [Var ?choice_id]
    [Throw "MakeChoice called with unbound variable"]
[end]
MakeChoice ?choice_id:
    [Not [Fragment ?choice_id ^CurrentScene]]
    [Not [ConditionalChoice ^CurrentFragment ?choice_id]]
    [Throw "No fragment or conditional choice found for" ^CurrentScene ^CurrentFragment ?choice_id]
[end]
MakeChoice ?choice_id:
    [GoToChoice ^CurrentFragment ?choice_id]
    [ConditionalChoice ^CurrentFragment ?choice_id]
    [Throw "Ambiguous choice ID. ConditionalChoice ID's and GoToChoice fragments should not overlap within a fragment" ^CurrentScene ^CurrentFragment ?choice_id]
[end]
MakeChoice ?choice_id:
    [GoToChoice ^CurrentFragment ?choice_id]
    [Fragment ?choice_id ^CurrentScene]
    [Not [TestConditions ?fragment_id]]
    [Throw "Conditions not met for " ?fragment_id]
[end]
MakeChoice ?choice_id:
    [GoToChoice ^CurrentFragment ?choice_id]
    [Fragment ?choice_id ^CurrentScene] # TODO no fragment case
    [UpdateCurrentFragment ?fragment_id]
[end]
MakeChoice ?choice_id:
    [ConditionalChoice ^CurrentFragment ?choice_id]
    [GetFromNextBestChoices ?fragment_id ?choice_id]
    [UpdateCurrentFragment ?fragment_id]
[end]

UpdateCurrentFragment ?fragment_id:
    [TestConditions ?fragment_id]
    [Visit ?fragment_id]
    [set ^CurrentFragment = ?fragment_id]
    [BestChoices ?fragment_id ?next_best]
    [set ^NextBestChoices = ?next_best]
[end]
UpdateCurrentFragment ?fragment_id:
    [Not [TestConditions ?fragment_id]]
    [Throw "Conditions not met for " ?fragment_id]
[end]

GetFromNextBestChoices ?next_fragment ?choice_id:
    [Member [?next_fragment ?choice_id] ^NextBestChoices]
[end]
GetFromNextBestChoices ?next_fragment ?choice_id:
    [Length ^NextBestChoices 0]
    [Throw "Next best choices is empty..."]
[end]
GetFromNextBestChoices ?next_fragment ?choice_id:
    [Not [Member [?next_fragment ?choice_id] ^NextBestChoices]]
    [Throw [?next_fragment ?choice_id] "is not a valid choice for" ^CurrentFragment Next best choices are ^NextBestChoices]
[end]


Render:
    [RenderScene ^CurrentScene]
    [RenderFragment ^CurrentFragment]
    [RenderChoices ?frag ^NextBestChoices]
[end]

RenderScene ?scene:
    Scene ?scene/Write [Br]
    Characters: [Br]
    [DoAll [Character ?id ?scene ?name] [PrintCharacter ?id ?scene]] [Br]
[end]

RenderFragment ?frag: [= ?frag root] No fragment selected
RenderFragment ?frag:
    [Different ?frag root]
    Content: [Content ?frag]
[end]

RenderChoices ?frag ?choices:
    Choices: [Br]
    [DoAll [Member ?c ?choices] [RenderChoice ?c]]
[end]

RenderChoice ?frag:
    ?frag\Write : [ChoiceLabel ?frag] [Br]
[end]
RenderChoice ?frag: 
    ?frag\Write : Continue [Br]
[end]